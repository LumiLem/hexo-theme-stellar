<script>
  ctx.fancybox = {
    selector: `<%- conf.selector %>`,
    css: `<%- conf.css %>`,
    js: `<%- conf.js %>`
  };
  var selector = '[data-fancybox]:not(.error), .with-fancybox .atk-content img:not([atk-emoticon])';
  if (ctx.fancybox.selector) {
    selector += `, ${ctx.fancybox.selector}`
  }
  var needFancybox = document.querySelectorAll(selector).length !== 0;
  if (!needFancybox) {
    const memos = document.getElementsByClassName('ds-memos');
    if (memos != undefined && memos.length > 0) {
      needFancybox = true;
    }
    const fancybox = document.getElementsByClassName('with-fancybox');
    if (fancybox != undefined && fancybox.length > 0) {
      needFancybox = true;
    }
    // 检查是否有实况照片
    const livePhotos = document.getElementsByClassName('livephoto-container');
    if (livePhotos != undefined && livePhotos.length > 0) {
      needFancybox = true;
    }
  }
  if (needFancybox) {
    utils.css(ctx.fancybox.css);
    utils.js(ctx.fancybox.js, { defer: true }).then(function () {
      
      // 实况照片自动播放设置
      let livePhotoAutoPlay = localStorage.getItem('livePhotoAutoPlay') !== 'false';
      
      // 切换自动播放设置
      function toggleLivePhotoAutoPlay() {
        livePhotoAutoPlay = !livePhotoAutoPlay;
        localStorage.setItem('livePhotoAutoPlay', String(livePhotoAutoPlay));
        return livePhotoAutoPlay;
      }
      
      // 创建实况照片 HTML 内容
      function createLivePhotoHTML(imageUrl, videoUrl) {
        const autoPlayEnabled = livePhotoAutoPlay;
        return `<div class="fancybox-livephoto-container"><div class="livephoto-content"><video class="livephoto-video" src="${videoUrl}" preload="metadata" playsinline disablepictureinpicture></video><img class="livephoto-image" src="${imageUrl}" alt="实况照片" /><div class="livephoto-control-wrapper"><div class="livephoto-icon"><svg class="livephoto-icon-svg ${autoPlayEnabled ? '' : 'disabled'}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/><circle cx="12" cy="12" r="6" stroke="currentColor" stroke-width="1.5" fill="none"/><circle cx="12" cy="12" r="3" fill="currentColor"/>${autoPlayEnabled ? '' : '<line x1="4" y1="4" x2="20" y2="20" stroke="currentColor" stroke-width="1.5"/>'}</svg><span class="livephoto-label">LIVE</span><svg class="livephoto-chevron" width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 4L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg></div><div class="livephoto-dropdown"><div class="livephoto-dropdown-item" data-action="toggle-autoplay"><span class="dropdown-text">${autoPlayEnabled ? '关闭自动播放' : '开启自动播放'}</span><svg class="dropdown-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="3" fill="currentColor"/>${autoPlayEnabled ? '' : '<line x1="4" y1="4" x2="20" y2="20"/>'}</svg></div></div></div></div></div>`;
      }
      
      // 初始化实况照片交互
      function initLivePhotoInteraction(slide) {
        try {
          let container = null;
          
          if (slide.htmlEl) {
            container = slide.htmlEl.classList?.contains('fancybox-livephoto-container')
              ? slide.htmlEl
              : slide.htmlEl.querySelector('.fancybox-livephoto-container');
          }
          if (!container && slide.el) {
            container = slide.el.querySelector('.fancybox-livephoto-container');
          }
          
          if (!container) return;
          
          const video = container.querySelector('.livephoto-video');
          const image = container.querySelector('.livephoto-image');
          const icon = container.querySelector('.livephoto-icon');
          const dropdown = container.querySelector('.livephoto-dropdown');
          const controlWrapper = container.querySelector('.livephoto-control-wrapper');
          
          if (!video || !image || !icon) return;
          
          const start = (e) => {
            e.stopPropagation();
            e.preventDefault();
            container.classList.add('zoom');
            video.currentTime = 0;
            video.play().catch((err) => {
              console.error('Live photo video play error:', err);
            });
          };
          
          const leave = (e) => {
            if (e) {
              e.preventDefault();
            }
            container.classList.remove('zoom');
            video.pause();
          };
          
          const handleVideoEnded = () => {
            container.classList.remove('zoom');
          };
          
          const preventContextMenu = (e) => {
            e.preventDefault();
            e.stopPropagation();
            return false;
          };
          
          const chevron = icon.querySelector('.livephoto-chevron');
          
          const showChevron = () => {
            controlWrapper?.classList.add('show-chevron');
          };
          
          const hideChevron = () => {
            if (!controlWrapper?.classList.contains('show-dropdown')) {
              controlWrapper?.classList.remove('show-chevron');
            }
          };
          
          const toggleDropdown = (e) => {
            e.stopPropagation();
            e.preventDefault();
            controlWrapper?.classList.toggle('show-dropdown');
          };
          
          const hideDropdown = () => {
            controlWrapper?.classList.remove('show-dropdown');
          };
          
          const isMobile = () => window.innerWidth <= 768;
          
          // 切换自动播放按钮
          const toggleAutoPlayButton = container.querySelector('[data-action="toggle-autoplay"]');
          if (toggleAutoPlayButton) {
            toggleAutoPlayButton.addEventListener('click', (e) => {
              e.stopPropagation();
              toggleLivePhotoAutoPlay();
              
              const text = toggleAutoPlayButton.querySelector('.dropdown-text');
              const iconSvg = toggleAutoPlayButton.querySelector('.dropdown-icon');
              const mainIconSvg = icon.querySelector('.livephoto-icon-svg');
              
              if (text) {
                text.textContent = livePhotoAutoPlay ? '关闭自动播放' : '开启自动播放';
              }
              if (iconSvg) {
                iconSvg.innerHTML = `
                  <circle cx="12" cy="12" r="10"/>
                  <circle cx="12" cy="12" r="6"/>
                  <circle cx="12" cy="12" r="3" fill="currentColor"/>
                  ${livePhotoAutoPlay ? '' : '<line x1="4" y1="4" x2="20" y2="20"/>'}
                `;
              }
              if (mainIconSvg) {
                mainIconSvg.innerHTML = `
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>
                  <circle cx="12" cy="12" r="6" stroke="currentColor" stroke-width="1.5" fill="none"/>
                  <circle cx="12" cy="12" r="3" fill="currentColor"/>
                  ${livePhotoAutoPlay ? '' : '<line x1="4" y1="4" x2="20" y2="20" stroke="currentColor" stroke-width="1.5"/>'}
                `;
              }
              
              if (isMobile()) {
                hideDropdown();
              }
            });
          }
          
          let hasHoveredDropdown = false;
          
          if (controlWrapper) {
            controlWrapper.addEventListener('mouseenter', () => {
              if (!isMobile()) {
                showChevron();
              }
            });
            controlWrapper.addEventListener('mouseleave', () => {
              if (!isMobile()) {
                hideChevron();
                if (hasHoveredDropdown) {
                  hideDropdown();
                  hasHoveredDropdown = false;
                }
              }
            });
          }
          
          if (dropdown) {
            dropdown.addEventListener('mouseenter', () => {
              if (!isMobile()) {
                hasHoveredDropdown = true;
              }
            });
          }
          
          if (chevron) {
            chevron.addEventListener('click', (e) => {
              if (!isMobile()) {
                toggleDropdown(e);
                hasHoveredDropdown = false;
              }
            });
          }
          
          if (icon) {
            icon.addEventListener('click', (e) => {
              if (isMobile()) {
                e.stopPropagation();
                toggleDropdown(e);
              }
            });
          }
          
          const closeOnClickOutside = (e) => {
            if (!controlWrapper?.contains(e.target)) {
              hideDropdown();
              hasHoveredDropdown = false;
              if (!isMobile()) {
                hideChevron();
              }
            }
          };
          document.addEventListener('click', closeOnClickOutside);
          
          icon.addEventListener('mouseenter', start);
          icon.addEventListener('mouseleave', leave);
          
          const livephotoContent = container.querySelector('.livephoto-content');
          if (livephotoContent) {
            livephotoContent.addEventListener('touchstart', (e) => {
              if (controlWrapper?.contains(e.target)) {
                return;
              }
              start(e);
            }, { passive: false });
            livephotoContent.addEventListener('touchend', (e) => {
              if (controlWrapper?.contains(e.target)) {
                return;
              }
              leave(e);
            }, { passive: false });
            livephotoContent.addEventListener('touchcancel', (e) => {
              if (controlWrapper?.contains(e.target)) {
                return;
              }
              leave(e);
            }, { passive: false });
          }
          
          container.addEventListener('contextmenu', preventContextMenu, { passive: false });
          icon.addEventListener('contextmenu', preventContextMenu, { passive: false });
          video.addEventListener('ended', handleVideoEnded);
          
          if (livePhotoAutoPlay) {
            setTimeout(() => {
              container.classList.add('zoom');
              video.currentTime = 0;
              video.play().catch((err) => {
                console.error('Live photo auto-play error:', err);
              });
            }, 300);
          }
          
          slide.livePhotoPause = () => {
            video.pause();
            video.currentTime = 0;
            container.classList.remove('zoom');
          };
          
          slide.livePhotoCleanup = () => {
            document.removeEventListener('click', closeOnClickOutside);
            icon.removeEventListener('mouseenter', start);
            icon.removeEventListener('mouseleave', leave);
            if (livephotoContent) {
              livephotoContent.removeEventListener('touchstart', start);
              livephotoContent.removeEventListener('touchend', leave);
              livephotoContent.removeEventListener('touchcancel', leave);
            }
            container.removeEventListener('contextmenu', preventContextMenu);
            icon.removeEventListener('contextmenu', preventContextMenu);
            video.removeEventListener('ended', handleVideoEnded);
            video.pause();
            video.src = '';
          };
        } catch (error) {
          console.error('Live photo init error:', error);
        }
      }
      
      // 清理实况照片资源
      function cleanupLivePhoto(slide) {
        if (slide?.livePhotoCleanup) {
          try {
            slide.livePhotoCleanup();
            slide.livePhotoCleanup = null;
          } catch (error) {
            console.error('Failed to cleanup live photo:', error);
          }
        }
      }
      
      // 自定义 Fancybox 绑定，支持实况照片
      function bindFancybox() {
        // 收集所有需要绑定的元素
        const elements = document.querySelectorAll(selector);
        const items = [];
        const elementMap = new Map();
        
        elements.forEach((el, index) => {
          // 检查是否为实况照片容器
          if (el.classList.contains('livephoto-container')) {
            // 实况照片
            const imageUrl = el.dataset.livephotoImage;
            const videoUrl = el.dataset.livephotoVideo;
            
            if (imageUrl && videoUrl) {
              items.push({
                html: createLivePhotoHTML(imageUrl, videoUrl),
                class: 'has-livephoto',
                thumb: imageUrl,
              });
            } else {
              // 降级为普通图片
              const img = el.querySelector('img');
              items.push({
                src: img?.src || img?.dataset?.src || imageUrl,
                type: 'image',
                thumb: img?.src || img?.dataset?.src || imageUrl,
              });
            }
          } else {
            // 普通图片
            items.push({
              src: el.src || el.dataset.src,
              type: 'image',
              thumb: el.src || el.dataset.src,
            });
          }
          
          elementMap.set(el, index);
        });
        
        // 为每个元素绑定点击事件
        elements.forEach((el) => {
          // 移除之前的事件监听器（如果有的话）
          if (el._fancyboxClickHandler) {
            el.removeEventListener('click', el._fancyboxClickHandler);
          }
          
          const clickHandler = (e) => {
            // 如果点击的是LIVE图标区域，不触发fancybox
            if (e.target.closest('.livephoto-overlay')) {
              return;
            }
            
            e.preventDefault();
            e.stopPropagation();
            const startIndex = elementMap.get(el);
            
            Fancybox.show(items, {
              theme: 'auto',
              zoomEffect: true,
              fadeEffect: true,
              startIndex: startIndex,
              backdropClick: 'close',
              dragToClose: true,
              closeButton: 'auto',
              keyboard: {
                Escape: 'close',
                ArrowRight: 'next',
                ArrowLeft: 'prev',
                Delete: 'close',
                Backspace: 'close',
                ArrowDown: 'next',
                ArrowUp: 'prev',
                PageUp: 'close',
                PageDown: 'close',
              },
              Carousel: {
                Thumbs: {
                  type: 'classic',
                  showOnStart: true,
                },
              },
              on: {
                ready: (fancybox) => {
                  const carousel = fancybox.getCarousel();
                  if (!carousel) return;
                  
                  const currentIndex = startIndex;
                  
                  carousel.getSlides().forEach((slide, index) => {
                    if (!slide.html && !slide.htmlEl) return;
                    
                    const slideEl = slide.el || slide.htmlEl;
                    const isLivePhotoSlide = slide.htmlEl?.classList?.contains('fancybox-livephoto-container') ||
                      slideEl?.querySelector('.fancybox-livephoto-container');
                    
                    if (isLivePhotoSlide && index === currentIndex) {
                      initLivePhotoInteraction(slide);
                    }
                  });
                  
                  carousel.on('change', (carousel, to, from) => {
                    if (from !== undefined) {
                      const slides = carousel.getSlides();
                      const prevSlide = slides[from];
                      if (prevSlide) {
                        if (prevSlide.livePhotoPause) {
                          prevSlide.livePhotoPause();
                        } else {
                          const container = prevSlide.el?.querySelector('.fancybox-livephoto-container') ||
                            prevSlide.htmlEl?.querySelector('.fancybox-livephoto-container');
                          if (container) {
                            const video = container.querySelector('.livephoto-video');
                            if (video) {
                              video.pause();
                              video.currentTime = 0;
                            }
                            container.classList.remove('zoom');
                          }
                        }
                      }
                    }
                    
                    const currentSlide = carousel.getSlides()[to];
                    if (currentSlide && (currentSlide.html || currentSlide.htmlEl)) {
                      setTimeout(() => {
                        const slideEl = currentSlide.el || currentSlide.htmlEl;
                        const isLivePhotoSlide = currentSlide.htmlEl?.classList?.contains('fancybox-livephoto-container') ||
                          slideEl?.querySelector('.fancybox-livephoto-container');
                        
                        if (isLivePhotoSlide) {
                          if (currentSlide.livePhotoCleanup) {
                            if (livePhotoAutoPlay) {
                              const container = slideEl?.querySelector('.fancybox-livephoto-container');
                              const video = container?.querySelector('.livephoto-video');
                              if (container && video) {
                                setTimeout(() => {
                                  container.classList.add('zoom');
                                  video.currentTime = 0;
                                  video.play().catch((err) => {
                                    console.error('Live photo auto-play error:', err);
                                  });
                                }, 300);
                              }
                            }
                          } else {
                            initLivePhotoInteraction(currentSlide);
                          }
                        }
                      }, 50);
                    }
                  });
                },
                destroy: (fancybox) => {
                  const carousel = fancybox.getCarousel();
                  if (carousel) {
                    carousel.getSlides().forEach((slide) => {
                      cleanupLivePhoto(slide);
                    });
                  }
                }
              },
            });
          };
          
          // 保存事件处理器引用以便后续移除
          el._fancyboxClickHandler = clickHandler;
          el.addEventListener('click', clickHandler);
        });
      }
      
      // 初始化绑定
      bindFancybox();
      
      // 监听动态内容变化
      const observer = new MutationObserver(() => {
        setTimeout(bindFancybox, 100);
      });
      
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
    })
  }
</script>
